{"componentChunkName":"component---src-templates-post-js","path":"/blog/filter-contentful-content-by-date","result":{"data":{"markdownRemark":{"html":"<p>I had a not-so-unusual problem the other day while working on another Gatsby/Contentful blog. I needed a way to set a <em>publish on</em> date for posts, and then filter said posts such that content with a future publish date would not be compiled into the blog until said date.</p>\n<p>In theory this should have been a very simple solution. However, while Contentful supports scheduled publishing, the source plugin <code>gatsby-source-contentful</code> does not recognize publish dates. In fact <a href=\"https://www.contentfulcommunity.com/t/api-for-scheduled-publishing/3087\" target=\"_blank\" rel=\"noopener nofollow\">the Contentful API does not support this feature yet</a> either, so the data wouldn't be available anyway.</p>\n<p>Therefore to tackle the first problem, we need something that we can access in our GraphQL query. To do this we create a <em>Publish Date</em> field in Contentful for our Post content type. We can then set this field equal to the date we have scheduled for our post. Now when Contentful publishes our post, it can also trigger a webhook to Netlify to deploy our site with the newly published content. Plus we can now access this data in <code>gatsby-node.js</code> and sort by our publish date in descending order.</p>\n<p><strong>gatsby-node.js</strong></p>\n<pre><code class=\"language-javascript\">exports.createPages = ({ graphql, actions }) => {\n  const { createPage } = actions\n  const loadPosts = new Promise((resolve, reject) => {\n    graphql(`\n      {\n        allContentfulPost(\n          sort: { fields: [publishDate], order: DESC }\n        ) {\n          edges {\n            node {\n              title\n              slug\n              publishDate\n            }\n          }\n        }\n      }\n    `).then(result => {\n      const posts = result.data.allContentfulPost.edges\n      const postsPerFirstPage = config.postsPerHomePage\n      const postsPerPage = config.postsPerPage\n      const numPages = Math.ceil(\n        posts.slice(postsPerFirstPage).length / postsPerPage\n      )\n      resolve()\n    })\n  })\n  return Promise.all([loadPosts])\n}\n</code></pre>\n<p>The next part is a little bit trickier - filtering out posts scheduled in the future. You might be asking why we would need to filter out posts that haven't been published yet and therefore have not even triggered a deploy. In fact you might even say something like:</p>\n<blockquote>\n<p>Why would we need to filter out posts that haven't been published yet, if they have not even triggered a deploy?</p>\n</blockquote>\n<p>To wit I say, \"what happens if you need to deploy another change in the meantime?\" The new problem is that our source plugin <code>gatsby-source-contentful</code> doesn't check the publish status of our Contentful content, and will attempt to include this content during build. So if for example we need to update a few styles or add a new component, when we attempt to build and deploy these updates they will include these <em>future</em> posts. Therefore we still need to filter these out.</p>\n<p>Fortunately we can use schema customization in Gatsby to achieve this functionality, as noted in <a href=\"https://github.com/gatsbyjs/gatsby/issues/17159#issuecomment-549091641\" target=\"_blank\" rel=\"noopener nofollow\">this comment on GitHub</a>. Just add the following to <code>gatsby-node.js</code> before our previous query:</p>\n<p><strong>gatsby-node.js</strong></p>\n<pre><code class=\"language-javascript\">exports.createSchemaCustomization = ({ actions, schema, getNode }) => {\n  actions.createTypes([\n    schema.buildObjectType({\n      name: 'ContentfulPost',\n      interfaces: ['Node'],\n      fields: {\n        isFuture: {\n          type: 'Boolean!',\n          resolve: source => new Date(source.publishDate) > new Date(),\n        }\n      }\n    })\n  ])\n}\n</code></pre>\n<p>And then we can use our new schema to filter our previous query like so:</p>\n<p><strong>gatsby-node.js</strong></p>\n<pre><code class=\"language-javascript\">graphql(`\n  {\n    allContentfulPost(\n      filter: { isFuture: { eq: false } }\n      sort: { fields: [publishDate], order: DESC }\n    ) {\n      edges {\n        node {\n          title\n          slug\n          publishDate\n        }\n      }\n    }\n  }\n`)\n</code></pre>\n<p>Now any posts with a <code>publishDate</code> set in the future will not be included in our build.</p>","frontmatter":{"date":"December 31, 2019","slug":"filter-contentful-content-by-date","title":"Filtering Contentful Content by Publish Date"}}},"pageContext":{"slug":"filter-contentful-content-by-date"}}}